# Email Notifications System

Система автоматических email уведомлений для Redmine, которая отправляет уведомления о новых задачах и изменениях в проектах.

## Описание

Проект состоит из двух основных компонентов:
- **Notific.py** - основной модуль для отправки email уведомлений
- **runner.py** - планировщик для автоматического запуска уведомлений по расписанию

## Функциональность

### Основные возможности:
- Автоматическая отправка email уведомлений о новых задачах в Redmine
- Поддержка HTML шаблонов для красивого оформления писем
- Фильтрация пользователей (исключение определенных email адресов)
- Логирование всех операций с ротацией файлов
- Планировщик для автоматического выполнения по расписанию
- Обработка ошибок и исключений

### Возможности уведомлений:
- Уведомления о новых задачах
- Уведомления об изменении статуса задач
- Уведомления о назначении задач
- Поддержка различных проектов
- Настраиваемые шаблоны писем

## Требования

- Python 3.6+
- MySQL/MariaDB база данных
- SMTP сервер для отправки писем

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd email_notifications_current
```

2. Создайте виртуальное окружение:
```bash
python -m venv venv
```

3. Активируйте виртуальное окружение:
```bash
# Windows
venv\Scripts\activate

# Linux/macOS
source venv/bin/activate
```

4. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Настройка

### Переменные окружения

Создайте файл `.env` или установите переменные окружения:

```bash
# Интервал выполнения в секундах (по умолчанию 300 = 5 минут)
EXECUTION_INTERVAL=300

# Для отладки - интервал в секундах
EMAIL_NOTIFIC_INTERVAL_SECONDS=15

# SMTP конфигурация (для send_sequrity_email.py)
SMTP_SERVER=mail.tez-tour.com
SMTP_PORT=25
SMTP_USER=help@tez-tour.com
SMTP_PASSWORD=your_smtp_password_here

# Получатель сервисного письма
EMAIL_RECIPIENT=security@tez-tour.com

# Отправитель (если не задан, используется SMTP_USER)
# EMAIL_SENDER=it_dep@tez-tour.com

# Тестовый режим (если задан, письмо уходит на этот адрес)
# TEST_EMAIL=test@example.com

# Запуск сервиса send_sequrity_email.py
# SERVICE_START=True

# Интервал проверки планировщика (например: "60 minutes")
# SERVICE_INTERVAL=60 minutes
```

### Настройка базы данных

Убедитесь, что в коде `Notific.py` правильно настроены параметры подключения к MySQL:
- Хост базы данных
- Имя пользователя и пароль
- Название базы данных

### Настройка SMTP

В файле `Notific.py` настройте параметры SMTP сервера:
- SMTP хост и порт
- Учетные данные для аутентификации
- Настройки TLS/SSL

Для `send_sequrity_email.py` SMTP параметры берутся только из `.env`.

## Использование

### Однократный запуск

Для однократной отправки уведомлений:
```bash
python Notific.py
```

### Запуск планировщика

Для автоматического выполнения по расписанию:
```bash
python runner.py
```

### Запуск в VS Code

Проект настроен для запуска в VS Code с помощью конфигураций отладки:

1. **Python Debugger: Current File** - запуск текущего файла
2. **Run: APScheduler service (runner.py)** - запуск планировщика
3. **Run: Single execution (Notific.py)** - однократное выполнение

## Структура проекта

```
email_notifications_current/
├── .vscode/                    # Настройки VS Code
│   ├── launch.json            # Конфигурации запуска
│   └── settings.json          # Настройки проекта
├── systemd/                   # Файлы для Linux systemd
│   ├── email-notific.service  # Сервис для systemd
│   └── README-linux-scheduler.md
├── venv/                      # Виртуальное окружение
├── Notific.py                 # Основной модуль уведомлений
├── runner.py                  # Планировщик
├── html_template.py           # HTML шаблоны для писем
├── requirements.txt           # Зависимости Python
├── .gitignore                # Исключения для Git
└── README.md                 # Этот файл
```

## Логирование

Система использует ротацию логов:
- **notific.log** - логи основного модуля (макс. 10MB, 5 файлов)
- **runner.log** - логи планировщика (макс. 5MB, 3 файла)

Уровни логирования:
- Файлы: INFO и выше
- Консоль: WARNING и выше

## Развертывание

### Linux (systemd)

1. Скопируйте файл сервиса:
```bash
sudo cp systemd/email-notific.service /etc/systemd/system/
```

2. Отредактируйте пути в файле сервиса
3. Запустите сервис:
```bash
sudo systemctl enable email-notific.service
sudo systemctl start email-notific.service
```

### Windows

Используйте планировщик задач Windows или запускайте как обычное приложение.

## Безопасность

- Все конфиденциальные данные (пароли, ключи) должны храниться в переменных окружения
- Логи не содержат чувствительной информации
- Используется TLS для SMTP соединений

## Разработка

### Отладка

Для отладки используйте VS Code с настроенными конфигурациями запуска или запускайте напрямую:

```bash
# Отладка с коротким интервалом
EMAIL_NOTIFIC_INTERVAL_SECONDS=15 python runner.py
```

### Тестирование

Перед развертыванием протестируйте:
1. Подключение к базе данных
2. Отправку тестового письма
3. Работу планировщика

## Лицензия

Проект для внутреннего использования.

## Поддержка

При возникновении проблем проверьте:
1. Логи приложения
2. Подключение к базе данных
3. Настройки SMTP сервера
4. Переменные окружения
